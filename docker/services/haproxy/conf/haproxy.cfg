global
    # 全局日志配置，推荐使用本地syslog
    log /dev/log local0 info
    log /dev/log local1 notice
    
    # 最大连接数
    maxconn 4096
    
    # 运行用户和组
    user root
    group root
    
    # 以守护进程方式运行
    daemon
    
    # 调优参数：每个进程的最大连接数
    maxconn 4096

defaults
    # 默认日志使用global设置
    log global
    
    # 使用TCP模式（四层负载均衡）
    mode tcp
    option tcplog
    
    # 超时配置
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms
    
    # 启用健康检查
    option tcp-check
    
    # 禁用HTTP错误检查（因为我们是TCP模式）
    option dontlognull
    
    # 如果后端服务器故障，自动将其从负载均衡池中移除
    option redispatch
    
    # 失败重试次数
    retries 3

# 前端配置 - JT808 TCP 服务（设备连接入口）
frontend jt808_tcp_frontend
    # 绑定IP和端口，监听JT808 TCP连接
    bind *:7100
    
    # 设置最大连接数
    maxconn 20000
    
    # 使用TCP模式
    mode tcp
    
    # 默认后端服务器组
    default_backend jt808_tcp_servers

# 后端配置 - JT808 TCP 网关服务器
backend jt808_tcp_servers
    # TCP模式
    mode tcp
    
    # 负载均衡算法
    # source: 基于源IP哈希，确保同一设备始终连接到同一网关
    balance leastconn
    
    # 会话保持时间（秒）
    timeout server 3h
    
    # 健康检查配置
    option tcp-check
    tcp-check connect port 7100
    
    # 服务器配置
    # 格式: server <name> <ip>:<port> check [options]
    server gateway1 gateway1:7100 check inter 10s fall 3 rise 2 weight 1
    server gateway2 gateway2:7100 check inter 10s fall 3 rise 2 weight 1

# udp 监听
listen jt1078_udp_frontend
    mode udp
    bind *:7100
    balance roundrobin
    server udp1 gateway1:7100 check
    server udp2 gateway2:7100 check

# 统计页面配置（可选，用于监控）
listen stats
    bind *:1936
    mode http
    stats enable
    stats hide-version
    stats realm Haproxy\ Statistics
    stats uri /
    stats auth admin:password
